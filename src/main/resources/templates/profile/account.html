<!DOCTYPE html>
<html lang="en"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>BookIt - My Account</title>
	<th:block th:insert="~{partials/meta-header :: meta-header}"></th:block>
	<th:block th:insert="~{partials/header-links :: header-links}"></th:block>
	<link rel="stylesheet" th:href="@{/css/profile/account.css}">
</head>
<body>
<th:block th:insert="~{partials/big-navbar :: big-navbar}"></th:block>

<div id="dogless-toast" th:if="${param.dogless}"
	 class="toast text-bg-warning position-fixed bottom-0 end-0 p-1 me-2 mb-2" style="z-index: 11"
	 role="alert">
	<div class="d-flex">
		<div type="button" class="ms-2 m-auto"><i id="warning-icon" class="fa-solid fa-circle-exclamation"></i></div>
		<div class="toast-body">
			Add a dog before making an appointment.
		</div>
		<button type="button" class="close-toast-btn btn-close btn-close-white me-2 m-auto"
				data-bs-dismiss="toast"></button>
	</div>
</div>

<div id="page-container">
	<div id="tab-container">

		<div id="my-dogs-group" class="settings-container">
			<div id="dogs-group-header" class="d-flex align-items-center justify-content-between">
				<h2>My Dogs</h2>
				<button id="add-dog-button" type="button" data-bs-toggle="modal"
						data-bs-target="#addDogModal">
					Add Dog
				</button>
			</div>
			<div id="dogs-list-group" class="list-group">
				<h4 th:if="${dogs.isEmpty()}">No dogs to display.</h4>
				<div th:each="dog : ${dogs}">
					<button th:id="${dog.id}" type="button"
							class="dog-button btn btn-success m-1">
						<span th:text="${dog.name}"></span>
					</button>
				</div>
			</div>
		</div>

		<div id="profile-info-group" class="settings-container">
			<h2>Profile Info <span id="save-param" th:if="${param.saved}">Profile saved!</span></h2>
			<form id="profile-form" th:method="POST" th:action="@{/my-profile/account}">
				<div class="profile-form-input">
					<label class="profile-label">First Name</label>
					<input class="profile-input" th:name="first-name" type="text" th:value="${user.firstName}">
				</div>

				<div class="profile-form-input">
					<label class="profile-label">Last Name</label>
					<input class="profile-input" th:name="last-name" type="text" th:value="${user.lastName}">
				</div>

				<div class="profile-form-input">
					<label class="profile-label">Username</label>
					<input class="profile-input" th:name="username" type="text" th:value="${user.username}">
				</div>

				<div class="profile-form-input">
					<label class="profile-label">Email</label>
					<input class="profile-input" th:name="email" type="text" th:value="${user.email}">
					<i th:if="${user.emailVerified}" class="fa-regular fa-square-check"></i>
				</div>
				<div th:if="${!user.emailVerified}">
					<span>Email has not been verified yet. <span id="resend-email-verification-span">Resend verification email</span>.</span>
				</div>

				<button id="edit-profile-save-btn" class="btn btn-success" type="submit">Save</button>
			</form>
		</div>
	</div>
</div>

<!-- Edit Dog Modal -->
<div class="modal fade" id="editDogModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title fs-5">Edit Dog</h2>
				<form class="btn btn-danger" id="delete-dog-form" th:method="POST">
					<input hidden th:name="_method" th:value="DELETE">
					<button id="delete-dog-btn" type="submit">Delete Dog</button>
				</form>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<form class="dog-form">
					<input id="edit-id-input" hidden type="number">
					<label>Name</label>
					<input id="edit-name-input" type="text" name="name" maxlength="30">
					<label>Breed</label>
					<select id="edit-breed-input" name="breed">
						<option th:each="breed : ${dogBreeds}"
								th:value="${#strings.capitalize(breed.toString())}"
								th:selected="${dog.breed == #strings.capitalize(breed.toString())}">
							<span th:text="${#strings.capitalize(breed.toString())}"></span>
						</option>
					</select>
					<label>Age</label>
					<input id="edit-age-input" type="number" name="age">
					<label>Sex</label>
					<select id="edit-sex-input" th:name="sex" required>
						<option value="M">Male</option>
						<option value="F">Female</option>
					</select>
					<label>Has Rabies Vaccination?</label>
					<input id="edit-rabies-input" type="checkbox" name="rabiesVaccinationStatus">
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button id="submit-edit-button" type="button" class="btn btn-success">Save</button>
			</div>
		</div>
	</div>
</div>

<th:block th:insert="~{partials/add-dog-modal :: add-dog-modal}"></th:block>

<th:block th:insert="~{partials/footer :: footer}"></th:block>

<th:block th:insert="~{partials/footer-links :: footer-links}"></th:block>

<script type="text/javascript" th:src="@{/js/profile/account.js}"></script>
<script src="https://kit.fontawesome.com/556c276549.js" crossorigin="anonymous"></script>
<script>

    (function ($) {


        //resend email verification
        $("#resend-email-verification-span").on("click", function () {
            try {
                fetch("/resendVerificationEmail", {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

            } catch (error) {
                console.log("Error sending verification email");
            }
        });

        // get current dog info
        let currentDogButton;

        $(".dog-button").on("click", async function () {

            currentDogButton = this;

            try {
                let response = await fetch("/dogs/" + this.id, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                response.json().then((data) => {
                    if (response.ok) {
                        $("#edit-id-input").val(data.id);
                        $("#edit-name-input").val(data.name);
                        $("#edit-breed-input").val(data.breed);
                        $("#edit-age-input").val(data.age);
                        $("#edit-sex-input").val(data.sex);
                        $("#edit-rabies-input").prop('checked', data.hasRabiesVaccination);
                        $("#delete-dog-form").prop("action", "/dogs/" + data.id);
                        $("#editDogModal").modal('show');
                    } else {
                        console.log("Failed to fetch availability data");
                    }
                });

            } catch (error) {
                console.log("Error fetching availability data:", error);
            }
        });

        $("#submit-edit-button").on('click', async function () {

            let hasRabiesVaccination = $("#edit-rabies-input").prop('checked');

            let dataToUpdate = {
                name: $("#edit-name-input").val(),
                breed: $("#edit-breed-input").val(),
                age: $("#edit-age-input").val(),
                sex: $("#edit-sex-input").val(),
                hasRabiesVaccination: hasRabiesVaccination
            };


            try {
                let response = await fetch("/dogs/" + $("#edit-id-input").val(), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToUpdate),
                });

                currentDogButton.value = $("#edit-name-input").val();
                currentDogButton.innerText = $("#edit-name-input").val();
                $("#editDogModal").modal('hide');

            } catch (error) {
                console.log("Error updating dog details:", error);
            }
        })

    })(jQuery);

</script>
</body>
</html>